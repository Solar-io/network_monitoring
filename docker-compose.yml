version: '3.8'

services:
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: netmon-api
    ports:
      - "${API_PORT:-8080}:8080"
    environment:
      - API_HOST=0.0.0.0
      - API_PORT=8080
      - DATABASE_URL=sqlite:////app/data/db.sqlite
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL}
      - LLM_API_URL=${LLM_API_URL}
      - LLM_API_KEY=${LLM_API_KEY}
      - LLM_DEFAULT_MODEL=${LLM_DEFAULT_MODEL:-claude-sonnet-4.5}
      - HEALTHCHECKS_URL=${HEALTHCHECKS_URL:-}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - BUSINESS_HOURS_START=${BUSINESS_HOURS_START:-08:00}
      - BUSINESS_HOURS_END=${BUSINESS_HOURS_END:-18:00}
      - BUSINESS_HOURS_DAYS=${BUSINESS_HOURS_DAYS:-1,2,3,4,5}
      - BUSINESS_HOURS_TIMEZONE=${BUSINESS_HOURS_TIMEZONE:-America/New_York}
    volumes:
      - ./data:/app/data
      - ./config:/app/config
      - ./logs:/app/logs
    restart: unless-stopped
    command: uvicorn src.api.main:app --host 0.0.0.0 --port 8080 --reload
    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8080/api/v1/health', timeout=5)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  scheduler:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: netmon-scheduler
    environment:
      - DATABASE_URL=sqlite:////app/data/db.sqlite
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL}
      - LLM_API_URL=${LLM_API_URL}
      - LLM_API_KEY=${LLM_API_KEY}
      - LLM_DEFAULT_MODEL=${LLM_DEFAULT_MODEL:-claude-sonnet-4.5}
      - HEALTHCHECKS_URL=${HEALTHCHECKS_URL:-}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - BUSINESS_HOURS_START=${BUSINESS_HOURS_START:-08:00}
      - BUSINESS_HOURS_END=${BUSINESS_HOURS_END:-18:00}
      - BUSINESS_HOURS_DAYS=${BUSINESS_HOURS_DAYS:-1,2,3,4,5}
      - BUSINESS_HOURS_TIMEZONE=${BUSINESS_HOURS_TIMEZONE:-America/New_York}
    volumes:
      - ./data:/app/data
      - ./config:/app/config
      - ./logs:/app/logs
      - ${SSH_KEY_PATH:-~/.ssh}:/root/.ssh:ro
    restart: unless-stopped
    command: python -m src.services.scheduler_service
    depends_on:
      api:
        condition: service_healthy

  internet-monitor:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: netmon-internet
    environment:
      - DATABASE_URL=sqlite:////app/data/db.sqlite
      - DISCORD_WEBHOOK_URL=${DISCORD_WEBHOOK_URL}
      - HEALTHCHECKS_URL=${HEALTHCHECKS_URL:-}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    volumes:
      - ./data:/app/data
      - ./config:/app/config
      - ./logs:/app/logs
    restart: unless-stopped
    command: python -m src.services.internet_monitor
    depends_on:
      api:
        condition: service_healthy

volumes:
  data:
  logs:

networks:
  default:
    name: netmon-network
